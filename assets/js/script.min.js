document.addEventListener("DOMContentLoaded",e=>{function t(){if(r.length){n="";for(let[e,t]of Object.entries(r))n+=`<li class="book-item" id="book-${e}">${t.title} - ${t.commentcount} comment${t.commentcount>1?"s":""}</li>`;document.querySelector("#books").innerHTML=n}}var o=window.location.pathname,r=[],n="",c="";fetch(o+"api/books",{method:"GET"}).then(e=>{if(e.ok)return e.json();throw"Error"}).then(e=>{r=e,t()}).catch(e=>{console.log(e)}),document.querySelector("#comment-test").addEventListener("submit",e=>{let t=document.querySelector("#idinputtest").value;e.target.setAttribute("action",`${o}api/books/${t}`)}),document.querySelector("#new-book").addEventListener("click",e=>{e.preventDefault(),fetch(o+"api/books",{method:"POST",body:new URLSearchParams(new FormData(document.querySelector("#new-book-form")))}).then(e=>{if(e.ok)return e.text();throw"Error"}).then(e=>{try{e=JSON.parse(e)}catch(e){}void 0!==e.error?alert(e.error):(document.querySelector("#new-book-form").reset(),e.commentcount=0,r.push(e),t())}).catch(e=>{console.log(e)})}),document.querySelector("#delete-all-books").addEventListener("click",e=>{confirm("Are you sure you want to delete all books?")&&fetch(o+"api/books",{method:"DELETE"}).then(e=>{if(e.ok)return e.text();throw"Error"}).then(e=>{try{e=JSON.parse(e)}catch(e){}void 0!==e.error?alert(e.error):(r=[],n="",document.querySelector("#books").innerHTML="",document.querySelector("#book-title").innerHTML="Select a book to see its details and comments",document.querySelector("#book-comments").innerHTML="",document.querySelector("#book-form").innerHTML="",alert(e.result))}).catch(e=>{console.log(e)})}),document.querySelector("#books").addEventListener("click",e=>{if(e.target.closest(".book-item")){let t=e.target.closest(".book-item").id.replace("book-","");document.querySelector("#book-title").innerHTML="<b>"+r[t].title+"</b> (id: "+r[t].id+")",fetch(o+"api/books/"+r[t].id,{method:"GET"}).then(e=>{if(e.ok)return e.text();throw"Error"}).then(e=>{try{e=JSON.parse(e)}catch(e){}c="";for(let[t,o]of Object.entries(e.comments))c+=`<li>${o}</li>`;let o=`\n\t\t\t\t<form id="newCommentForm">\n\t\t\t\t\t<input type="text" class="form-control mb-2" id="commentToAdd" name="comment" placeholder="New Comment">\n\t\t\t\t\t<button type="button" class="btn btn-primary mb-2 addComment" id="${e.id}" data-i="${t}">Add Comment</button><br>\n\t\t\t\t\t<button type="button" class="btn btn-danger deleteBook" id="${e.id}" data-i="${t}">Delete Book</button>\n\t\t\t\t</form>\n\t\t\t\t`;document.querySelector("#book-comments").innerHTML=c,document.querySelector("#book-form").innerHTML=o}).catch(e=>{console.log(e)})}}),document.querySelector("#book-details").addEventListener("click",e=>{if(e.target.closest(".addComment")){e.preventDefault();let t=e.target.closest(".addComment").dataset.i,n=document.querySelector("#commentToAdd").value;fetch(o+"api/books/"+e.target.closest(".addComment").id,{method:"POST",body:new URLSearchParams(new FormData(document.querySelector("#newCommentForm")))}).then(e=>{if(e.ok)return e.text();throw"Error"}).then(e=>{try{e=JSON.parse(e)}catch(e){}void 0!==e.error?(alert(e.error),"book not found"==e.error&&(document.querySelector("#book-title").innerHTML="Select a book to see its details and comments",document.querySelector("#book-comments").innerHTML="",document.querySelector("#book-form").innerHTML="",document.querySelector("#book-"+t).remove(),r.splice(t,1))):(document.querySelector("#commentToAdd").value="",c+=`<li>${n}</li>`,document.querySelector("#book-comments").innerHTML=c,r[t].commentcount++,document.querySelector("#book-"+t).innerHTML=r[t].title+" - "+r[t].commentcount+" comment"+(r[t].commentcount>1?"s":""))}).catch(e=>{console.log(e)})}if(e.target.closest(".deleteBook")&&(e.preventDefault(),confirm("Are you sure you want to delete this book?"))){let t=e.target.closest(".deleteBook").dataset.i;fetch(o+"api/books/"+e.target.closest(".deleteBook").id,{method:"DELETE"}).then(e=>{if(e.ok)return e.text();throw"Error"}).then(e=>{try{e=JSON.parse(e)}catch(e){}void 0!==e.error?alert(e.error):(alert(e.result),document.querySelector("#book-title").innerHTML="Select a book to see its details and comments",document.querySelector("#book-comments").innerHTML="",document.querySelector("#book-form").innerHTML="",document.querySelector("#book-"+t).remove(),r.splice(t,1))}).catch(e=>{console.log(e)})}})});